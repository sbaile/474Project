#1. Data Collection

```{r}
install.packages(c("quantmod", "TTR", "PerformanceAnalytics", "PortfolioAnalytics"))
library(quantmod)
library(TTR)
library(PerformanceAnalytics)
library(PortfolioAnalytics)

```

```{r}
# Retrieve stock data for multiple stocks
symbols <- c("AAPL", "GOOG", "MSFT", "TSLA")
getSymbols(symbols, src = "yahoo", from = "2020-01-01", to = Sys.Date())

```

#2. Calculate Curve

```{r}
# Function to calculate Coppock curve for a stock
calculate_coppock_curve <- function(stock_data) {
  roc_14 <- ROC(Cl(stock_data), n = 14 * 21)  # Approximate monthly using 21 trading days
  roc_11 <- ROC(Cl(stock_data), n = 11 * 21)
  coppock_curve <- WMA(roc_14 + roc_11, n = 10 * 21)  # 10-month WMA
  return(coppock_curve)
}

# Calculate Coppock curves for all stocks
coppock_curves <- list()
for (symbol in symbols) {
  coppock_curves[[symbol]] <- calculate_coppock_curve(get(symbol))
}


```

#3. Identify Buy signals

```{r}
# Function to identify buy signals from Coppock curve
identify_buy_signals <- function(coppock_curve) {
  buy_signals <- ifelse(lag(coppock_curve, 1) < 0 & coppock_curve > 0, 1, 0)
  return(buy_signals)
}

# Identify buy signals for each stock
buy_signals <- list()
for (symbol in symbols) {
  buy_signals[[symbol]] <- identify_buy_signals(coppock_curves[[symbol]])
}

# Merge buy signals into a single xts object (aligned by date)
buy_signals_df <- do.call(merge, buy_signals)
colnames(buy_signals_df) <- symbols  # Name columns with stock symbols

# Convert the xts object to a data frame
buy_signals_df <- as.data.frame(buy_signals_df)
buy_signals_df[is.na(buy_signals_df)] <- 0
# View the resulting buy signals data frame
tail(buy_signals_df)


```

#4. Calculate stock returns
```{r}
# Calculate daily returns for each stock
stock_returns <- list()
for (symbol in symbols) {
  stock_returns[[symbol]] <- dailyReturn(Cl(get(symbol)))
}

# Combine returns into a single xts object
portfolio_returns_data <- do.call(merge, stock_returns)
colnames(portfolio_returns_data) <- symbols


```

#5. Apply Buy signals

```{r}
# Adjust returns using buy signals
adjusted_returns <- portfolio_returns_data
for (symbol in symbols) {
  adjusted_returns[, symbol] <- stock_returns[[symbol]] * buy_signals[[symbol]]
}

```

#6. Build Portfolio

```{r}
# Define equal weights for simplicity (can adjust based on your strategy)
weights <- rep(1 / length(symbols), length(symbols))

# Calculate the portfolio's returns based on weighted individual stock returns
portfolio_returns <- Return.portfolio(adjusted_returns, weights = weights)

# Check the first few rows of the portfolio returns
head(portfolio_returns)

```

#7. Backtest/Analyze performance

```{r}
# Plot cumulative returns of the portfolio
chart.CumReturns(portfolio_returns, main = "Cumulative Portfolio Returns", legend.loc = "bottomleft")

# Calculate Sharpe ratio
sharpe_ratio <- SharpeRatio(portfolio_returns)
print(sharpe_ratio)

# Calculate maximum drawdown
max_drawdown <- maxDrawdown(portfolio_returns)
print(max_drawdown)

```